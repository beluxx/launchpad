#!/bin/sh

# Copyright 2012 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

set -e

if [ -z "$1" ]; then
    echo "$0: Need root combo loader directory as an argument."
    exit 1
fi

if [ -z "$2" ]; then
    echo "$0: Need yui build version to use as default as second argument"
    exit 1
fi

BUILD_DIR=$1
YUI_VERSION=$2

# Populate YUI.
if [ ! -h $BUILD_DIR/yui ]; then
    ln -sf `basename $YUI_VERSION` $BUILD_DIR/yui
fi

# And YUI 2, for now.
if [ ! -d $BUILD_DIR/yui2 ]; then
    cp -a lib/canonical/launchpad/icing/yui_2.7.0b/build $BUILD_DIR/yui2
fi

# Copy in our modules.
rm -rf $BUILD_DIR/lp
mkdir $BUILD_DIR/lp
for jsdir in lib/lp/*/javascript ; do
    app=$(echo $jsdir | sed -e 's,lib/lp/\(.*\)/javascript,\1,')
    cp -a $jsdir $BUILD_DIR/lp/$app
done
# ... and delete tests.
find $BUILD_DIR/lp -name 'tests' -type d | xargs rm -rf

# Minify our JS.
bin/lpjsmin -p $BUILD_DIR/lp
