=======================
Publishing History Page
=======================

The Publishing History page hangs off a distribution source page and
shows the complete history of a package in all series.

    >>> from lp.soyuz.tests.test_publishing import SoyuzTestPublisher
    >>> from lp.soyuz.enums import (
    ...     PackagePublishingStatus)
    >>> stp = SoyuzTestPublisher()
    >>> login('foo.bar@canonical.com')
    >>> stp.prepareBreezyAutotest()
    >>> source_pub = stp.getPubSource(
    ...     "test-history", status=PackagePublishingStatus.PUBLISHED)
    >>> logout()

    >>> anon_browser.open(
    ...     'http://launchpad.test/ubuntutest/+source/test-history/'
    ...     '+publishinghistory')

    >>> table = find_tag_by_id(anon_browser.contents, 'publishing-summary')
    >>> print(extract_text(table))
    Date    Status    Target     Pocket   Component Section Version
    ... UTC Published Breezy ... release  main      base    666
    Published ... ago
    >>> print(table.findAll("tr")[2].td["colspan"])
    8

Copy the package to a new distribution named "foo-distro". The publishing
history page of Foo-distro should show that the package was copied, but no
intermediate archive information.

    >>> login('foo.bar@canonical.com')
    >>> from lp.soyuz.model.archive import ArchivePurpose
    >>> copy_creator = stp.factory.makePerson(name='person123')
    >>> new_distro = stp.factory.makeDistribution(name='foo-distro')
    >>> new_distroseries = stp.factory.makeDistroSeries(
    ...     name='foo-series', distribution=new_distro)
    >>> new_archive = stp.factory.makeArchive(
    ...     distribution=new_distro,
    ...     purpose=ArchivePurpose.PRIMARY)
    >>> new_pub1 = source_pub.copyTo(
    ...     new_distroseries, source_pub.pocket, new_archive,
    ...     creator=copy_creator)
    >>> logout()

    >>> anon_browser.open(
    ...     'http://launchpad.test/%s/+source/test-history/'
    ...     '+publishinghistory' % new_distro.name)

    >>> table = find_tag_by_id(anon_browser.contents, 'publishing-summary')
    >>> print(extract_text(table))
    Date    Status    Target          Pocket   Component Section Version
    ... UTC Pending   Foo-series      release  main      base    666
    Copied from ubuntutest breezy-autotest in Primary Archive for Ubuntu Test


Copying from "Foo-distro" to a new distribution "Another-distro". It should
show the intermediate archive Foo-distro on Another-distro's history page,
since we copied the package from there. It should also show that the
original distribution was Ubuntutest breezy-autotest.

    >>> login('foo.bar@canonical.com')
    >>> from lp.soyuz.model.archive import ArchivePurpose
    >>> new_distro = stp.factory.makeDistribution(name='another-distro')
    >>> new_distroseries = stp.factory.makeDistroSeries(
    ...     name='another-series', distribution=new_distro)
    >>> new_archive = stp.factory.makeArchive(
    ...     distribution=new_distro,
    ...     purpose=ArchivePurpose.PRIMARY)
    >>> new_pub2 = new_pub1.copyTo(
    ...     new_distroseries, source_pub.pocket, new_archive,
    ...     creator=copy_creator)
    >>> logout()

    >>> anon_browser.open(
    ...     'http://launchpad.test/%s/+source/test-history/'
    ...     '+publishinghistory' % new_distro.name)

    >>> table = find_tag_by_id(anon_browser.contents, 'publishing-summary')
    >>> print(extract_text(table))
    Date    Status    Target          Pocket   Component Section Version
    ... UTC Pending   Another-series  release  main      base    666
    Copied from Primary Archive for Foo-distro by Person123
    Originally uploaded to ubuntutest breezy-autotest in Primary Archive for Ubuntu Test

A publishing record will be shown as deleted in the publishing history after a
request for deletion by a user.

    >>> login('foo.bar@canonical.com')
    >>> unused = source_pub.requestDeletion(
    ...     stp.factory.makePerson(), "fix bug 1")
    >>> logout()

    >>> anon_browser.open(
    ...     'http://launchpad.test/ubuntutest/+source/test-history/'
    ...     '+publishinghistory')

    >>> table = find_tag_by_id(anon_browser.contents, 'publishing-summary')
    >>> print(extract_text(table))
    Date    Status    Target     Pocket   Component Section Version
            Deleted   Breezy ... release  main      base    666
    Deleted ... ago by ... fix bug 1
    Published ... ago

Links to bug reports are added for bugs mentioned in the removal comment.

    >>> print(anon_browser.getLink("bug 1").url)
    http://launchpad.test/bugs/1
